#!/bin/bash

__ScriptVersion="0.1"

# Parameters
wp_norm=~/Pictures/wallpapers/wp_normal.png
wp_rofi=~/Pictures/wallpapers/wp_rofi.png

#===  FUNCTION  ================================================================
#         NAME:  usage
#  DESCRIPTION:  Display usage information.
#===============================================================================
function usage ()
{
    echo "Usage :  $0 [options] [--]

    Options:
    -h|help       Display this message
    -v|version    Display script version"

}    # ----------  end of function usage  ----------


function focused_disp () {
    OFFSET_RE="\+([-0-9]+)\+([-0-9]+)"
    
    # Get the window position
    eval "$(xdotool getmouselocation --shell)"
    
    # Loop through each screen and compare the offset with the window
    # coordinates.
    monitor_index=0
    while read name width height xoff yoff
    do
        if [ "${X}" -ge "$xoff" \
          -a "${Y}" -ge "$yoff" \
          -a "${X}" -lt "$(($xoff+$width))" \
          -a "${Y}" -lt "$(($yoff+$height))" ]
        then
            monitor=$name
            break
        fi
        ((monitor_index++))
    done < <(xrandr | grep -w connected |
        sed -r "s/^([^ ]*).*\b([-0-9]+)x([-0-9]+)$OFFSET_RE.*$/\1 \2 \3 \4 \5/" |
        sort -nk4,5)
    
    # If we found a monitor, echo it out, otherwise print an error.
    if [ ! -z "$monitor" ]
    then
        # echo $monitor
        echo $monitor_index
        exit 0
    else
        echo "Couldn't find any monitor for the current window." >&2
        exit 1
    fi
}

#-----------------------------------------------------------------------
#  Handle command line arguments
#-----------------------------------------------------------------------

while getopts ":su" opt
do
  case $opt in

    s|set       )
        monitor_count=$(xrandr | grep -E " connected.*x[0-9]+\+[0-9]+\+[0-9]+" -c)
        if [ $monitor_count -eq 1 ]; then
            feh --bg-fill $wp_rofi &
        elif [ $(focused_disp) -eq 0 ]; then
            feh --bg-fill $wp_rofi $wp_normal &
            #feh --bg-fill ~/Pictures/wallpapers/wp_rofi.png ~/Pictures/wallpapers/nord_sea.png &
        fi
        ;;
    u|unset     )
        feh --bg-fill ~/Pictures/wallpapers/wp_normal.png &;;
    *           )
        feh --bg-fill ~/Pictures/wallpapers/wp_normal.png &;;
  esac
done
shift $(($OPTIND-1))
